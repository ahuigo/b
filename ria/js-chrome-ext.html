<!DOCTYPE html>
<html lang="zh-cn">
<head>
<script>
if(!('noModule' in HTMLScriptElement.prototype)){
alert('你的浏览器不能很好的支持 es6，请用最新的chrome、firefox浏览!')
}
const MD_URL='post/ria/js-chrome-ext.md';
</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1" />
<title>ria chrome dev</title>
<meta name="author" content="ahuigo">
<link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css">
<script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue-router@3.0.1/dist/vue-router.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/monokai-sublime.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/leancloud-storage@3.10.0/dist/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/valine@1.3.3/dist/Valine.min.js"></script>
<link href="/b/../a/css/main2.css" rel="stylesheet">
<script src="/b/../a/js/marked.js"></script>
<script src="/b/../a/js/toc.js"></script>
</head>
<body class="layout-documentation page-layout">
<div id="app">
<div :id="'imgview'" v-if="imgsrc" @click="imgsrc=null"><img :src="imgsrc"></div>
<div class="pure-menu pure-menu-horizontal">
<div>
<ul class="pure-menu-list">
<li class="pure-menu-item">
<div class="menu-toggle" :class="{a:true}" @click="showMenu=!showMenu">
</div>
</li>
<li class="pure-menu-item"><a href="//github.com/ahuigo">AHUIGO</a></li>
<li class="pure-menu-item"><a class="button is-primary" href="/b/index.html">Home</a></li>
<li class="pure-menu-item"><a class="button is-primary" href="/b/atom.xml">Rss</a></li>
<li class="pure-menu-item"><a class="button is-primary" href="/a#/README.md">Readme</a></li>
<li class="pure-menu-item"><a class="button is-primary" href="/a/demo/fiddle/fiddle.html">Fiddle</a></li>
</ul>
</div>
</div>
<div class="main">
<div :class="{left:true, 'active':showMenu}" >
<tree-folder :nodes="nodes" :class="{'active':showMenu}" :show="show"></tree-folder>
</div>
<div class="middle" v-on="showMenu?{click:r=>showMenu=false}:{}">
<router-view></router-view>
<pre id="markdown" v-pre>---
title: ria chrome dev
date: 2018-10-06
updated: 2018-10-06
---
# Preface
Reference:
https://developer.chrome.com/extensions/examples/tutorials/getstarted/icon.png

# todo
http://blog.jobbole.com/46608/
http://www.cnblogs.com/guogangj/p/3235703.html#t1

# ext list
http://weibo.com/p/1001603917441372715024 link to  http://get.ftqq.com/8215.get


# manifest.json
It contains extension&#x27;s name, description, version_number. 
declare to chrome what the extension is going to do, and what permissions it requires in order.[manifest](https://developer.chrome.com/extensions/manifest)

In our example will decalre a `browser action` and `activeTab permission` to see the URL of the current tab, and the `host permission` to access the external google image search API.

	{
	  &quot;manifest_version&quot;: 2,

	  &quot;name&quot;: &quot;Getting started example&quot;,
	  &quot;description&quot;: &quot;This extension shows a Google Image search result for the current page&quot;,
	  &quot;version&quot;: &quot;1.0&quot;,

	  &quot;browser_action&quot;: {
		&quot;default_icon&quot;: &quot;icon.png&quot;,
		&quot;default_popup&quot;: &quot;popup.html&quot;
	  },
	  &quot;permissions&quot;: [
		&quot;activeTab&quot;,
		&quot;https://*.googleapis.com/&quot;, //被允许访问的网站
	  ]
	}

&gt; JavaScript and HTML must be in separate files: see our Content Security

# Page Action
http://files.cnblogs.com/guogangj/chrome-plugin-page-action-demo.7z
这个插件只有4个文件，其中两个还是图标，那就只剩下一个必须的manifest.json和一个background.js了。

mainifest.json：

	{
		 &quot;manifest_version&quot;: 2,
		 &quot;name&quot;: &quot;cnblogs.com viewer&quot;,
		 &quot;version&quot;: &quot;0.0.1&quot;,
		 &quot;background&quot;: { &quot;scripts&quot;: [&quot;background.js&quot;] },
		 &quot;permissions&quot;: [&quot;tabs&quot;],
		 &quot;page_action&quot;: {
			  &quot;default_icon&quot;: {
				   &quot;19&quot;: &quot;cnblogs_19.png&quot;,
				   &quot;38&quot;: &quot;cnblogs_38.png&quot;
			  },
			  &quot;default_title&quot;: &quot;cnblogs.com article information&quot;
		 }
	}

注意：这里是“page_action”而不是“browser_action”属性了. `pageAction` 是用于单个页面的(位于地址栏最右边)，而`browserAction` 是 用于全局的

页面按钮可以通过[chrome.pageAction] API控制，可以在不同的标签页中灵活的显示或者隐藏。

“permissions”属性里的“tabs”是必须的，否则下面的js不能获取到tab里的url，而这个url是我们判断是否要把小图标show出来的依据。
background是什么概念？
这是一个很重要的东西，可以把它认为是chrome插件的主程序，理解这个很关键，一旦插件被启用（有些插件对所有页面都启用，有些则只对某些页面启用），chrome就给插件开辟了一个独立的javascript运行环境（又称作运行上下文），用来跑你指定的background script，在这个例子中，也就是background.js。

	function getDomainFromUrl(url){
		 var host = &quot;null&quot;;
		 if(typeof url == &quot;undefined&quot; || null == url)
			  url = window.location.href;
		 var regex = /.*\:\/\/([^\/]*).*/;
		 var match = url.match(regex);
		 if(typeof match != &quot;undefined&quot; &amp;&amp; null != match)
			  host = match[1];
		 return host;
	}

	function checkForValidUrl(tabId, changeInfo, tab) {
		 if(getDomainFromUrl(tab.url).toLowerCase()==&quot;www.cnblogs.com&quot;){
			  chrome.pageAction.show(tabId);
		 }
	};

	chrome.tabs.onUpdated.addListener(checkForValidUrl);

代码中，我们使用了一个正则表达式去匹配url，获取出其中的domain部分，如果domain部分是“www.cnblogs.com”的话，就把小图标show出来

# script
scripts 分
- background script
- popup script
- content script(注入到页面| source content scripts)
- self script(页面自身的脚本)

为了避免content script 与页面自身(self script)发生冲突，chrome 开辟了一个独立的运行空间给content script 使用，它只能访问页面的dom 而不能直接访问page script

那么，Content Script会在什么时候运行呢？
默认情况下，是在网页加载完了和页面脚本执行完了，页面转入空闲的情况下（Document Idle），但这个是可以改变的，详情可参考https://developer.chrome.com/extensions/content_scripts.html，查看其中的“run_at”。

由于处于不同的运行环境中，Content Script和Background Script不能直接互相访问，那它们之间如何通信？
通过Message！这个之后的代码中会有。

我们完成这么一个例子：
抓取网页的内容得依靠content_script.js，然后通过sendMessage/onMessage和background.js交换数据，background.js将url信息通过ajax（XMLHttpRequest）发送给localhost，获取此页面的第一次访问的时间，最后，用户点小图标，popup.html出现，popup.html会读取（代码在popup.js中）background.js中的articleData的数据，把它显示出来。这就是整个过程。

## content js
通过`chrome.runtime.sendMessage` 向background js 发送消息

	var postInfo = $(&quot;div.postDesc&quot;);
	if(postInfo.length!=1){
		chrome.runtime.sendMessage({type:&quot;cnblog-article-information&quot;, error:&quot;获取文章信息失败.&quot;});
	}
	else{
		var msg = {
			type: &quot;cnblog-article-information&quot;,
			title : $(&quot;#cb_post_title_url&quot;).text(),
			postDate : postInfo.find(&quot;#post-date&quot;).text(),
			author : postInfo.find(&quot;a&quot;).first().text(),
			url: document.URL
		};
		chrome.runtime.sendMessage(msg);
	}

## background js
`chrome.runtime.onMessage` 接收消息

	var articleData = {};
	articleData.error = &quot;加载中...&quot;;
	chrome.runtime.onMessage.addListener(function(request, sender, sendRequest){
		if(request.type!==&quot;cnblog-article-information&quot;)
			return;
		articleData = request;
		articleData.firstAccess = &quot;获取中...&quot;;
		if(!articleData.error){
			$.ajax({
				url: &quot;http://localhost/first_access.php&quot;,
				cache: false,
				type: &quot;POST&quot;,
				data: JSON.stringify({url:articleData.url}),
				dataType: &quot;json&quot;
			}).done(function(msg) {
				if(msg.error){
					articleData.firstAccess = msg.error;
				} else {
					articleData.firstAccess = msg.firstAccess;
				}
			}).fail(function(jqXHR, textStatus) {
				articleData.firstAccess = textStatus;
			});
		}
	});

## popup js
popup 通过`chrome.extension.getBackgroundPage` 获取background 的变量

	document.addEventListener(&#x27;DOMContentLoaded&#x27;, function () {
		var data = chrome.extension.getBackgroundPage().articleData;
		if(data.error){
			$(&quot;#message&quot;).text(data.error);
			$(&quot;#content&quot;).hide();
		}else{
			$(&quot;#message&quot;).hide();
			$(&quot;#content-title&quot;).text(data.title);
			$(&quot;#content-author&quot;).text(data.author);
			$(&quot;#content-date&quot;).text(data.postDate);
			$(&quot;#content-first-access&quot;).text(data.firstAccess);
		}
	});

# Load Extension
Extension that you download from web store is packaged up as `.crx`. For development, chrome gives a quick way to loading up your working directory for testing

1. Visit `chrome://extensions`
2. Ensure that the `Developer mode`
3. Click `Load unpacked extension`

# debug
Right click `inspect popup`
Right click `inspect view`
https://developer.chrome.com/extensions/tut_debugging

- 重新cmd+r 加载extension, 清除缓存、dns、重启浏览器..
- 其它插件的干扰，如`Go Agent`
- 使用`incognito` 模式

# API
https://developer.chrome.com/extensions/api_index

Chrome的程序和扩展程序都非常喜欢调用chrome.* APIs，这些API可以让你通过不同的方式来操控浏览器，API通常会在后台脚本里面被调用，这是我找到的一些常用API：

- chrome.tabs 标签页：新建、刷新、关闭、访问和操控标签页
- chrome.history 历史：访问用户浏览历史
- chrome.bookmarks 书签：添加、编辑、移除和搜索用户书签
- chrome.events 事件：监听或者管理浏览器发生的事件
- chrome.commands 命令：添加或者改变键盘命令
- chrome.contextMenus 右键：添加条目到右键下文菜单
- chrome.omnibox 多功能框（地址栏）：添加多功能框关键字，使用户可以向扩展发送指令或者激活扩展

这些权限必须在`manifest.json` 中声明 才能使用

	{
	  &quot;permissions&quot;: [
	    &quot;contextMenus&quot;,
	    &quot;tabs&quot;,
	    &quot;https://google.com/*&quot;,
	    &quot;https://developer.mozilla.org/*&quot;
	  ]
	}

## contextMenus 右键菜单
chrome.contextMenus 是另一个提供用户界面，方便用户和扩展交互的方式。Chrome的右键菜单通过右键激活，但根据激活内容的变化，菜单内容也会做相应改变。

chrome.contextMenusAPI允许你向为不同内容激活的右键菜单添加项目，若要使用此API，则在manifest.json文件中声明相应的contextMenus权限。

目前可用的激活内容有：

	all, page, frame, selection, link, editable,image, video,  audio

对应：所有内容、页面、框架、选择、链接、可编辑、图像、视频、音频，以下这个例子需要contextMenus 和tabs权限，他可以使扩展为右键菜单添加一个根项目，然后添加一个子菜单，用来复制当前的页面到一个新选项卡。[b]

	var root = chrome.contextMenus.create({
	   title: &#x27;MyExtension&#x27;,
	   contexts: [&#x27;page&#x27;]
	}, function () {
	   var subMenu = chrome.contextMenus.create({
		   title: &#x27;Duplicate Tab&#x27;
		   contexts: [&#x27;page&#x27;],
		   parentId: root,
		   onclick: function (evt) {
			   chrome.tabs.create({ url: evt.pageUrl })
		   }
	   });
	});

# Reference
[chrome.pageAction]: https://developer.chrome.com/extensions/pageAction
[chrome.contextMenus]: http://developer.chrome.com/extensions/contextMenus.html
</pre>
<div id="pager" v-pre></div>
<div class="hr"></div>
<div class="share" style="display:flex;justify-content:space-between">
<div>
<h4>关注我</h4>
<div>
<iframe width="120" height="22" :src="`https://platform.twitter.com/widgets/follow_button.4a8202e5fcbfb5ba8d36683841f4d020.en.html#screen_name=${config.twitter_user}&width=67&height=22&show_count=false&show_screen_name=true`"></iframe>
<iframe width="120" height="22" :src="`https://widget.weibo.com/relationship/followbutton.php?btn=light&style=1&uid=${config.weibo_uid}&width=67&height=22&language=zh_cn`"></iframe>
</div>
</div>
<div>
<h4>分享文章</h4>
<div>
<span class="icon twitter-icon" @click="openShare('twitter', this)"></span>
<span class="icon weibo-icon" @click="openShare('weibo')"></span>
</div>
</div>
</div>
<div class="hr"></div>
<div id="comments"></div>
</div>
<div class="right">
<div id="toc"></div>
<div id="search" class="pure-form">
<fieldset>
<input id="search_q" @keyup.enter="searchBlog($('#search_q').value)">
<button @click="searchBlog($('#search_q').value)" class="pure-button pure-button-primary">搜索</button>
</fieldset>
</div>
</div>
</div>
<button class="button is-primary" onclick="window.scroll(0, 10)" id="up">Up</button>
<button class="button is-primary" onclick="window.scrollTo(0,document.body.scrollHeight)" id="down">Down</button>
</div>
<template id="tree-folder">
<ul class="pure-menu-list" v-if="show">
<li class="pure-menu-item" v-for="(file,index) in nodes" :key="file.path">
<a v-if="file.type==='dir'" :type="file.type" @click="openFolder(file)" class="folder">{{file.name}}
</a>
<a v-else :type="file.type" class="file" :href="('/'+file.path).replace(/^\/post\b/, '/b').slice(0,-3)">{{file.name.slice(0,-3)}} </a>
<tree-folder v-if="file.nodes" :show="file.show" :nodes="file.nodes"></tree-folder>
</li>
</ul>
</template>
<template id="md">
<div id="content" v-html="marked(md)"></div>
</template>
<script src="/b/../a/js/blog2.js"></script>
</body>
</html>
